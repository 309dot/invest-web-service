# 2025-10-31 Vercel API 점검 로그

## 오늘 진행한 작업
- Vercel 프로덕션 URL(`https://invest-web-service.vercel.app`) 상태 점검 (HTTP 200 정상 응답)
- 주요 API 엔드포인트 기능 확인: `/api/stocks/search`, `/api/exchange-rate`
- `/api/stocks/historical-price` 호출 결과 및 오류 메시지 수집

## 발견된 이슈
- `historical-price` 엔드포인트가 항상 404(데이터 없음) 응답을 반환
  - 응답 본문: `{"success":false,"error":"해당 날짜의 가격을 찾을 수 없습니다."}`
  - 원인: 서버 측 Alpha Vantage 클라이언트가 `process.env.NEXT_PUBLIC_ALPHA_VANTAGE_API_KEY`만 참조하고 있었고, Vercel에는 `ALPHA_VANTAGE_API_KEY`만 설정된 상태라 API 키가 전달되지 않음

## 조치 사항
- `mgk-dashboard/lib/apis/alphavantage.ts`에서 환경 변수 읽기 순서를 `ALPHA_VANTAGE_API_KEY` → `NEXT_PUBLIC_ALPHA_VANTAGE_API_KEY` → 기본값으로 보완
- 수정 후 로컬 ESLint 검사(`read_lints`)에서 추가 경고/오류 없음 확인

## 다음 단계
- 코드 수정 배포 후 `/api/stocks/historical-price` 재호출하여 정상 가격 응답 여부 확인
- Alpha Vantage 일일 호출 제한(5 req/min, 500 req/day) 감안한 모니터링 필요

---

## 추가 점검: 포지션 생성/삭제 기능 (웹 API)

### 테스트 절차
- `POST /api/positions`로 `portfolioId=vercel-test`, `symbol=AAPL` 수동 매수 생성 요청 (2024-01-15, 1주, $185.50)
  - ✅ 응답: `200 OK`, `positionId=vercel-test_AAPL`
  - ⚠️ 후속 거래 기록 없음 → `/api/transactions` 내부 호출이 Firestore `exchangeRate` 필드 undefined로 실패 추정
- `GET /api/positions?portfolioId=vercel-test` → 생성된 포지션 확인 (shares=1)
- `DELETE /api/positions/vercel-test_AAPL` 호출 → ❌ `405`와 함께 Next 404 페이지 반환 (API 라우트 미배포 혹은 빌드 누락)
- 정리용으로 `POST /api/transactions` (type=sell, exchangeRate=1) 호출해 보유 수량 0으로 조정 후, 생성된 거래는 `/api/transactions/{id}`로 삭제 처리

### 발견된 문제
- **삭제 기능 실패**: `/api/positions/[id]` 라우트가 프로덕션에서 404/405를 반환하여 포지션 삭제 불가
- **거래 생성 실패**: `/api/transactions`가 `exchangeRate` 필드 undefined를 허용하지 않아, `/api/positions`에서 자동으로 기록하려던 초기 거래가 생성되지 않음

### 조치/요청 사항
- `/api/positions` 및 `/api/positions/[id]` 라우트에 `runtime = 'nodejs'` 강제 지정, 삭제 시 연관 거래 일괄 삭제하도록 서비스 계층 보완
- `createTransaction`에서 `exchangeRate`가 정의된 경우에만 Firestore 필드로 저장하도록 수정 → `/api/positions` 초기 거래 생성 fetch 과정 성공
- `/api/positions` 라우트의 내부 `/api/transactions` 호출에 오류 처리 추가(실패 시 에러 반환) 및 UI(`PortfolioOverview`)에서 삭제 결과/거래 수 노출
- 테스트로 생성된 문서: `users/default_user/portfolios/vercel-test/positions/vercel-test_AAPL` (shares=0 상태) → 라우트 수정 후 삭제 권장

---

## 2025-10-31 오후: 한글 종목 검색 & 뉴스 개인화 개선

### 주요 개선 사항
- ✅ Yahoo Finance 한글 검색 API 개선 (`lib/apis/yahoo-finance.ts`)
  - lang 파라미터 `ko-KR` 적용 및 섹터/자산유형 정규화 (lowercase)
  - 종목 설명 필드 보강, assetType → `stock`/`etf` 형태로 통일
- ✅ 종목 추가 시 로그인 사용자 UID 전달 (`AddStockModal` → `/api/positions`)
  - 저장 실패 케이스(익명 default_user) 완화, 사용자별 포트폴리오 경로 일치
- ✅ 뉴스 수집 로직 한글화 (`lib/apis/news.ts`, `/api/news/personalized`)
  - 보유 종목명/티커 기반 한글 검색어 구성, Google News `hl=ko`, `gl=KR` 적용
  - 결과 미존재 시 영어로 재조회, RSS description HTML 태그 제거
  - 요약 텍스트 생성 및 `summary` 필드 추가
- ✅ 뉴스 UI 개선 (`app/news/page.tsx`)
  - 카드 설명에 href 문자열 노출 제거, 제목 클릭 시 모달로 요약/상세 표시
  - 모달에서 영향 종목/개인화 점수/원문 보기 제공

### 검증 메모
- `curl '/api/stocks/search?q=삼성전자'` 실행 예정 (빌드 후) → 한글 검색 결과 확인 필요
- `/api/news/personalized` 호출 시 `summary` 포함 JSON 반환 및 `portfolioSymbols`가 보유 종목과 일치하는지 점검
- 프론트에서 뉴스 제목 클릭 시 모달 열림, 외부 링크 버튼으로 원문 이동 여부 확인

---

## 2025-10-31 야간: 다중 통화 & 데이터 동기화 고도화

### 주요 개선 사항
- ✅ TypeScript 타깃을 `es2020`으로 상향(`tsconfig.json`) → ES6 이상 전용 정규식/이터레이터 빌드 오류 예방
- ✅ 한국 종목 역사 가격 조회 지원
  - `alphavantage.ts`에 Yahoo Finance 기반 일자별 시세 수집 로직 추가 (`.KS/.KQ` 자동 판별)
  - `/api/stocks/historical-price`가 시장/심볼에 따라 미국·한국 가격 모두 반환
  - Add Stock 모듈(모달 + 페이지)에서 한국 종목도 날짜 선택 시 자동으로 가격 입력
- ✅ 통화 표시 규칙 개선 (`formatCurrency`)
  - KRW → `123,456원`, USD → `$123,456.78` 형식으로 일관화, 음수 시 부호 유지
- ✅ 포지션/거래 API 실사용자 ID 적용
  - `/api/positions`, `/api/transactions` GET/POST/DELETE 전반에 `userId` 필수 전달
  - `PortfolioOverview`, `TransactionForm`, `TransactionsPage`, 포지션 상세 등 클라이언트에서 사용자 UID 동기화
- ✅ 거래 기록에 통화 정보 저장
  - Transaction 도메인에 `currency` 필드 추가, 생성 시 KRW/ USD 구분 저장
  - 자동투자 생성(`generateAutoInvestTransactions`) 및 수동 거래 모두 현지 통화 기준으로 관리
  - UI에서 포지션·거래 금액 표시 시 통화별 포맷 적용
- ✅ 뉴스 본문 확보 및 정제
  - `/api/news/personalized`에서 상위 5개 기사 원문을 서버에서 직접 수집 → HTML 제거/엔티티 디코딩 후 `content` 필드 제공
  - 모달 UI가 요약(`summary`) + 원문(`content`) 모두 노출, 스크롤 영역 정리
- ✅ 한국 종목 검색명 보강
  - Yahoo 응답의 `shortname` 우선 사용, 한글 미포함 시 대체명 자동 선택
- ✅ AI 어드바이저 폴백 추가
  - `lib/services/ai-advisor.ts`에서 외부 GPT 호출 실패 시 로컬 요약 생성
  - `AIAdvisorCard`에 폴백 표시 안내 추가


### 추가 확인 요소
- Add Stock → 수동 매수 시 미국/한국 양쪽 모두 가격 자동 입력되는지 실기 테스트
- `/api/positions`, `/api/transactions` 호출 시 `userId` 누락 시 오류 메시지가 올바르게 노출되는지 확인
- 뉴스 모달에서 본문이 과도하게 길 경우(>1500자) 말줄임 처리 정상 여부 점검

