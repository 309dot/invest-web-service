# 2025-11-02 서비스 개선 작업 로그

## 작업 완료 항목

### 1. 거래이력 조회 및 재계산
- **문제**: 포지션 조회 시 Firestore 쿼리에서 `orderBy('date', 'asc')`가 복합 인덱스를 요구해 "The query requires an index" 오류 발생.
- **해결**: 쿼리에서 `orderBy`를 제거하고 메모리에서 정렬하도록 수정. `getPortfolioPositions`와 `recalculatePositionFromTransactions`에서 적용.

### 2. 자동 투자 거래 생성 개선
- **문제**: 자동 투자 시작일 이후의 거래가 고정된 기준 단가로만 생성됨.
- **개선**:
  - Alpha Vantage / Yahoo Finance를 통해 각 거래일별 실제 시세 조회
  - 시세 조회 실패 시 입력값을 폴백으로 사용
  - `pricePerShare` 파라미터를 선택 사항으로 변경
  - 시장(미국/국내) 정보를 함께 전달

### 3. 포트폴리오 총계 통화 분리
- **문제**: 포트폴리오 총합에서 USD와 KRW를 구분하지 않고 단순 합산하여 수익 계산이 잘못됨.
- **개선**:
  - `calculatePortfolioTotals` 함수를 통화별로 분리된 구조로 변경
  - 응답: `{ byCurrency: { USD: {...}, KRW: {...} }, combined: {...} }`
  - PortfolioOverview에서 통화별 투자 현황을 표시

### 4. 설정 페이지 정리
- **변경**: 이메일 알림 기능만 유지
- **제거**: 뉴스 자동 수집, 모니터링 종목, 투자 설정 등
- **안내**: 투자 관련 세부 설정은 각 종목 상세 화면에서 개별 관리

### 5. 포지션 상세 화면 포트폴리오 식별 개선
- **문제**: 상세 페이지와 자동 투자 API가 포트폴리오 ID를 `positionId`에서 분리하려고 하여 "포지션을 찾을 수 없습니다" 오류 발생
- **개선**:
  - 목록 → 상세 이동 시 `portfolioId`를 쿼리 파라미터로 전달
  - 상세 페이지가 `portfolioId` 쿼리 또는 `deriveDefaultPortfolioId`를 사용해 정확한 포트폴리오를 조회
  - 자동 투자 API(`/api/positions/[id]/auto-invest`)가 쿼리 파라미터로 전달된 `portfolioId`를 사용해 스케줄 조회/갱신
  - 자동 투자 설정 변경 시에도 동일한 포트폴리오 ID를 재사용하도록 상태 관리 추가

### 6. 포트폴리오 요약/보유 종목 UI 개선
- **문제**: 달러/원화가 혼합된 합계가 잘못 표시되고 액션 버튼이 요약 카드에 위치함
- **개선**:
  - 포트폴리오 요약 카드에서 통화별 투자금/평가금/수익률을 분리 표시하고, 표시 통화 기준 합산은 선택적(환율 변환)으로 제공
  - 새 `FeatureCurrencyToggle` 컴포넌트로 각 기능 내에서 통화 표시를 바로 전환 가능 (요약/잔액 카드에 적용)
  - 새로고침·종목 추가 버튼을 보유 종목 카드 헤더로 이동시켜 맥락 정리
  - 거래 드롭다운을 "거래 추가 / 거래 수정 / 포지션 삭제"로 분리하고 상세 페이지 이동 링크 수정

### 7. 내비게이션 및 기타 정리
- 상단 내비게이션에서 `설정` 메뉴 제거 (프로필 드롭다운으로 접근)
- 불필요한 통화 요약 블록 제거 및 Balance 카드 헤더에 통화 토글/접근성 문구 추가

### 8. 자동 투자 재생성 안정화
- **문제**: 자동 투자 스케줄 수정 시 외부 시세 API 실패로 전체 요청이 500 에러로 종료
- **개선**:
  - 히스토리컬 가격 조회 실패 시 제공된 기준 단가로 자동 폴백 적용
  - 거래 재생성 실패 시 500 대신 상세 메시지를 반환하고 UI에서 안내할 수 있도록 구조화

### 8-1. 포지션 수익률 계산 보정
- **문제**: 재계산 시 최근 거래 단가를 그대로 현재가로 덮어써 META/FIG/BRK-B 등의 손익이 음수로 표시됨
- **개선**: 기존 `currentPrice`가 존재하면 유지하고, 없는 경우에만 최근 거래 단가를 초기값으로 사용하도록 조정

### 9. 거래 이력 통화 분리
- **문제**: 거래 통계가 모든 금액을 달러 기준으로만 집계
- **개선**:
  - `calculateTransactionStats`를 USD/KRW로 분리 집계하도록 리팩터링
  - 거래 이력 상단 카드에서 통화별 매수/매도/평균단가/순익을 구분 표시하고, 환율이 있을 때만 표시 통화 기준 합산을 제공
  - 거래 페이지에도 통화 토글 적용

### 10. 매도 거래 모달 추가
- **문제**: 매도 거래를 기록하려면 개별 포지션 상세 화면에서만 가능해 번거로움이 컸음
- **개선**:
  - `SellStockModal` 신설 → 포지션을 선택해 매도 금액/수량/수수료/세금 입력 후 즉시 거래 기록
  - 거래 이력 페이지 헤더에 `매도 기록` 버튼 추가, 기록 완료 시 리스트/통계 자동 갱신
  - 매도 시 보유 수량 검증 및 과다 매도 방지

---

## 현재 상태

### 빌드 결과
- ✅ `npm run lint` 통과 (기존 경고만 유지)
- ✅ `npm run build` 성공 (메타데이터 경고만 발생, 기능에는 영향 없음)
- ✅ 설정 페이지 크기 감소 (4.2kB → 3.24kB)

### 미해결 사항
1. **거래 추가 오류**: "포지션을 찾을 수 없습니다" - Vercel 배포 후 서버 로그 확인 필요
2. **매도 기록**: TransactionForm에 'sell' 타입이 있으나, 매도만 조회하는 전용 페이지 필요
3. **자동 투자 금액 변경**: UI에 시작일 선택 기능 이미 존재, 거래 재생성 검증 필요
4. **수익 계산**: META, FIG, BRK-B 마이너스 수익 원인 - 데이터 검증 필요

---

## 배포 지침

```bash
cd /Users/a309/Documents/GitHub/invest-web-service
git add mgk-dashboard history_log
git commit -m "feat: currency separation and auto-invest price sync improvements"
git push origin main
```

Vercel이 자동으로 배포를 시작합니다.

