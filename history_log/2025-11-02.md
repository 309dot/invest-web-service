# 2025-11-02 서비스 개선 작업 로그

## 작업 완료 항목

### 1. 거래이력 조회 및 재계산
- **문제**: 포지션 조회 시 Firestore 쿼리에서 `orderBy('date', 'asc')`가 복합 인덱스를 요구해 "The query requires an index" 오류 발생.
- **해결**: 쿼리에서 `orderBy`를 제거하고 메모리에서 정렬하도록 수정. `getPortfolioPositions`와 `recalculatePositionFromTransactions`에서 적용.

### 2. 자동 투자 거래 생성 개선
- **문제**: 자동 투자 시작일 이후의 거래가 고정된 기준 단가로만 생성됨.
- **개선**:
  - Alpha Vantage / Yahoo Finance를 통해 각 거래일별 실제 시세 조회
  - 시세 조회 실패 시 입력값을 폴백으로 사용
  - `pricePerShare` 파라미터를 선택 사항으로 변경
  - 시장(미국/국내) 정보를 함께 전달

### 3. 포트폴리오 총계 통화 분리
- **문제**: 포트폴리오 총합에서 USD와 KRW를 구분하지 않고 단순 합산하여 수익 계산이 잘못됨.
- **개선**:
  - `calculatePortfolioTotals` 함수를 통화별로 분리된 구조로 변경
  - 응답: `{ byCurrency: { USD: {...}, KRW: {...} }, combined: {...} }`
  - PortfolioOverview에서 통화별 투자 현황을 표시

### 4. 설정 페이지 정리
- **변경**: 이메일 알림 기능만 유지
- **제거**: 뉴스 자동 수집, 모니터링 종목, 투자 설정 등
- **안내**: 투자 관련 세부 설정은 각 종목 상세 화면에서 개별 관리

### 5. 포지션 상세 화면 포트폴리오 식별 개선
- **문제**: 상세 페이지와 자동 투자 API가 포트폴리오 ID를 `positionId`에서 분리하려고 하여 "포지션을 찾을 수 없습니다" 오류 발생
- **개선**:
  - 목록 → 상세 이동 시 `portfolioId`를 쿼리 파라미터로 전달
  - 상세 페이지가 `portfolioId` 쿼리 또는 `deriveDefaultPortfolioId`를 사용해 정확한 포트폴리오를 조회
  - 자동 투자 API(`/api/positions/[id]/auto-invest`)가 쿼리 파라미터로 전달된 `portfolioId`를 사용해 스케줄 조회/갱신
  - 자동 투자 설정 변경 시에도 동일한 포트폴리오 ID를 재사용하도록 상태 관리 추가

### 6. 포트폴리오 요약/보유 종목 UI 개선
- **문제**: 달러/원화가 혼합된 합계가 잘못 표시되고 액션 버튼이 요약 카드에 위치함
- **개선**:
  - 포트폴리오 요약 카드에서 통화별 투자금/평가금/수익률을 분리 표시하고, 표시 통화 기준 합산은 선택적(환율 변환)으로 제공
  - 새 `FeatureCurrencyToggle` 컴포넌트로 각 기능 내에서 통화 표시를 바로 전환 가능 (요약/잔액 카드에 적용)
  - 새로고침·종목 추가 버튼을 보유 종목 카드 헤더로 이동시켜 맥락 정리
  - 거래 드롭다운을 "거래 추가 / 거래 수정 / 포지션 삭제"로 분리하고 상세 페이지 이동 링크 수정

### 7. 내비게이션 및 기타 정리
- 상단 내비게이션에서 `설정` 메뉴 제거 (프로필 드롭다운으로 접근)
- 불필요한 통화 요약 블록 제거 및 Balance 카드 헤더에 통화 토글/접근성 문구 추가

### 8. 자동 투자 재생성 안정화
- **문제**: 자동 투자 스케줄 수정 시 외부 시세 API 실패로 전체 요청이 500 에러로 종료
- **개선**:
  - 히스토리컬 가격 조회 실패 시 제공된 기준 단가로 자동 폴백 적용
  - 거래 재생성 실패 시 500 대신 상세 메시지를 반환하고 UI에서 안내할 수 있도록 구조화

### 8-1. 포지션 수익률 계산 보정
- **문제**: 재계산 시 최근 거래 단가를 그대로 현재가로 덮어써 META/FIG/BRK-B 등의 손익이 음수로 표시됨
- **개선**: 기존 `currentPrice`가 존재하면 유지하고, 없는 경우에만 최근 거래 단가를 초기값으로 사용하도록 조정

### 9. 거래 이력 통화 분리
- **문제**: 거래 통계가 모든 금액을 달러 기준으로만 집계
- **개선**:
  - `calculateTransactionStats`를 USD/KRW로 분리 집계하도록 리팩터링
  - 거래 이력 상단 카드에서 통화별 매수/매도/평균단가/순익을 구분 표시하고, 환율이 있을 때만 표시 통화 기준 합산을 제공
  - 거래 페이지에도 통화 토글 적용

### 10. 매도 거래 모달 추가
- **문제**: 매도 거래를 기록하려면 개별 포지션 상세 화면에서만 가능해 번거로움이 컸음
- **개선**:
  - `SellStockModal` 신설 → 포지션을 선택해 매도 금액/수량/수수료/세금 입력 후 즉시 거래 기록
  - 거래 이력 페이지 헤더에 `매도 기록` 버튼 추가, 기록 완료 시 리스트/통계 자동 갱신
  - 매도 시 보유 수량 검증 및 과다 매도 방지

### 11. 매도 거래 자동 가격 입력
- 거래 입력 모달에서 `매도`를 선택하면 해당 날짜의 시세를 자동으로 조회하여 단가 필드를 채우도록 했습니다.
- 사용자가 값을 수정하면 자동 갱신이 중단되고, 다시 날짜/유형을 변경하면 최신 시세로 재조회합니다.

### 12. 거래 정책(주말/시장 시간) 적용
- 자동 투자 거래 생성 시 시장별(미국/한국) 영업일을 기준으로 거래 날짜를 재조정하고, 주말에는 거래가 생성되지 않도록 변경했습니다.
- 거래 입력 폼은 선택한 날짜가 휴장일이거나 해당 시장 기준 미래일인 경우 자동으로 다음 가능한 영업일로 이동하며 안내 메시지를 표시합니다.
- 모든 거래 생성 경로에서 시장 정보를 일관되게 계산하도록 `tradingCalendar` 유틸리티를 신설했습니다.

### 13. 환율 조회 및 기록 개선
- `/api/exchange-rate`가 Alpha Vantage의 `FX_DAILY` 데이터를 활용해 요청 날짜(휴장일은 직전 영업일) 환율을 반환하도록 개선했습니다.
- 자동 투자로 생성된 USD 거래는 동일 날짜의 환율을 함께 저장해 향후 손익 계산 시 환산 값의 근거를 남깁니다.
- 거래 입력 폼에서도 동일한 API를 사용해 과거 환율을 자동 채워 넣습니다.

### 14. 거래 통계 통화 판별 보강
- 거래 생성 API가 통화 정보를 서비스 계층에 전달하도록 수정했습니다.
- `calculateTransactionStats`가 포지션 통화/시장 정보를 참조해 과거에 잘못 저장된 거래도 USD/KRW로 재분류할 수 있게 했습니다.
- 포지션 상세 거래 조회에서 Firestore 복합 인덱스 없이 동작하도록 정렬 로직을 메모리로 이동했습니다.

---

## 현재 상태

### 빌드 결과
- ✅ `npm run lint` 통과 (기존 경고만 유지)
- ✅ `npm run build` 성공 (메타데이터 경고만 발생, 기능에는 영향 없음)
- ✅ 설정 페이지 크기 감소 (4.2kB → 3.24kB)

### 미해결 사항
1. **QA 필요**: 자동 투자 금액 변경 시나리오를 실데이터로 재확인 (Vercel 환경)
2. **모니터링**: META/FIG/BRK-B 손익 수치가 정상화되었는지 실시간 데이터로 확인 필요

---

## 배포 지침

```bash
cd /Users/a309/Documents/GitHub/invest-web-service
git add mgk-dashboard history_log
git commit -m "feat: currency separation and auto-invest price sync improvements"
git push origin main
```

Vercel이 자동으로 배포를 시작합니다.

