# 2025-11-02 서비스 개선 작업 로그

## 작업 완료 항목

### 1. 거래이력 조회 및 재계산
- **문제**: 포지션 조회 시 Firestore 쿼리에서 `orderBy('date', 'asc')`가 복합 인덱스를 요구해 "The query requires an index" 오류 발생.
- **해결**: 쿼리에서 `orderBy`를 제거하고 메모리에서 정렬하도록 수정. `getPortfolioPositions`와 `recalculatePositionFromTransactions`에서 적용.

### 2. 자동 투자 거래 생성 개선
- **문제**: 자동 투자 시작일 이후의 거래가 고정된 기준 단가로만 생성됨.
- **개선**:
  - Alpha Vantage / Yahoo Finance를 통해 각 거래일별 실제 시세 조회
  - 시세 조회 실패 시 입력값을 폴백으로 사용
  - `pricePerShare` 파라미터를 선택 사항으로 변경
  - 시장(미국/국내) 정보를 함께 전달

### 3. 포트폴리오 총계 통화 분리
- **문제**: 포트폴리오 총합에서 USD와 KRW를 구분하지 않고 단순 합산하여 수익 계산이 잘못됨.
- **개선**:
  - `calculatePortfolioTotals` 함수를 통화별로 분리된 구조로 변경
  - 응답: `{ byCurrency: { USD: {...}, KRW: {...} }, combined: {...} }`
  - PortfolioOverview에서 통화별 투자 현황을 표시

### 4. 설정 페이지 정리
- **변경**: 이메일 알림 기능만 유지
- **제거**: 뉴스 자동 수집, 모니터링 종목, 투자 설정 등
- **안내**: 투자 관련 세부 설정은 각 종목 상세 화면에서 개별 관리

### 5. 포지션 상세 화면 포트폴리오 식별 개선
- **문제**: 상세 페이지와 자동 투자 API가 포트폴리오 ID를 `positionId`에서 분리하려고 하여 "포지션을 찾을 수 없습니다" 오류 발생
- **개선**:
  - 목록 → 상세 이동 시 `portfolioId`를 쿼리 파라미터로 전달
  - 상세 페이지가 `portfolioId` 쿼리 또는 `deriveDefaultPortfolioId`를 사용해 정확한 포트폴리오를 조회
  - 자동 투자 API(`/api/positions/[id]/auto-invest`)가 쿼리 파라미터로 전달된 `portfolioId`를 사용해 스케줄 조회/갱신
  - 자동 투자 설정 변경 시에도 동일한 포트폴리오 ID를 재사용하도록 상태 관리 추가

---

## 현재 상태

### 빌드 결과
- ✅ `npm run lint` 통과 (기존 경고만 유지)
- ✅ `npm run build` 성공 (메타데이터 경고만 발생, 기능에는 영향 없음)
- ✅ 설정 페이지 크기 감소 (4.2kB → 3.24kB)

### 미해결 사항
1. **거래 추가 오류**: "포지션을 찾을 수 없습니다" - Vercel 배포 후 서버 로그 확인 필요
2. **매도 기록**: TransactionForm에 'sell' 타입이 있으나, 매도만 조회하는 전용 페이지 필요
3. **자동 투자 금액 변경**: UI에 시작일 선택 기능 이미 존재, 거래 재생성 검증 필요
4. **수익 계산**: META, FIG, BRK-B 마이너스 수익 원인 - 데이터 검증 필요

---

## 배포 지침

```bash
cd /Users/a309/Documents/GitHub/invest-web-service
git add mgk-dashboard history_log
git commit -m "feat: currency separation and auto-invest price sync improvements"
git push origin main
```

Vercel이 자동으로 배포를 시작합니다.

