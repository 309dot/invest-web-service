# 2025-11-03 작업 내역

## 통화 로직 개선
- `lib/currency.ts` 신규 추가, USD/KRW 환율 캐시 및 변환 유틸 정리
- `calculatePortfolioTotals`/`calculateTransactionStats` 등 통화 합산 로직 일원화
- `/api/balance`, `/api/transactions` 응답에 환율 메타 및 합산 정보 포함
- `PortfolioOverview`, `TransactionsPage` 표시 로직을 통합 데이터에 맞게 정리

## AI 어드바이저 안정화
- `/api/ai-advisor`에서 `GPT_OSS_API_KEY` 사전 검사 및 표준 에러 코드 응답
- `AIAdvisorResult` 구조화(`recommendations` 객체화, `riskScore` 등 추가)
- `AIAdvisorCard`, 주간 리포트에서 새 데이터 구조와 에러 메시지 대응

## 포트폴리오 분석 화면 리팩터링
- `components/analysis/*` 하위에 `RiskSection`, `AllocationPieChart`, `TopContributorsChart`, `GPTSummaryCard`, `RecommendationList` 분리
- `portfolio/analysis/page.tsx`를 모듈화된 컴포넌트 기반 레이아웃으로 교체 및 AI 진단 연동

## QA 자동화
- `scripts/qa/dashboard-consistency-check.js` 추가, 포지션 총액 vs 거래 총액 검증 스크립트 작성
- `package.json`에 `npm run qa:consistency` 스크립트 등록

## 거래 이력 및 자동 투자 개선
- `/api/transactions`에 미래 일자 검증 추가, 잘못된 거래 등록 차단
- 국내 종목 통화 판별 로직 강화(`lib/services/transaction.ts`, `transactions/page.tsx`)로 4/6자리 숫자 티커는 KRW로 통일 표시
- 거래 API에서 `upcomingAutoInvests` 정보 제공 및 UI 카드 추가로 당일 자동 투자 예정·완료 상태 시각화

## 손익 계산 로직 보강
- 수익률 계산을 총 투자금 기준으로 통일(`calculateReturnRate` 재정의)하고 마지막 체결가 폴백 적용
- `formatPercent` 반올림 로직 조정으로 미세 손익도 표시(-0.01% 등)

## 추가 개선 (거래/손익 정합성)
- `getPortfolioPositions`에 실시간 시세 연동(`AlphaVantage`, `Yahoo Finance`)을 추가하여 평가 금액/수익률을 실제 브로커리지와 동기화
- 거래 정규화 시 주말·미래 일자를 자동 보정하고, 휴일/미래 거래는 Firestore에 수정 반영 (`normalizeTransactions`, `createTransaction`)
- 자동 투자 스케줄에서 다음 실행일 계산을 `getNextScheduledTradingDate` 기반으로 재구성하고 UI에서 `대기/오늘/완료` 상태를 구분 표시
- `auto-invest` 생성 시 미래 거래를 무시하고, 거래 화면에 예정 안내 문구를 세분화

## 해외 시장 거래·자동투자 정합성 개선
- 미국 시장 거래일과 한국 시각 표시를 분리해 `/api/transactions` 응답에 `displayDate`를 추가하고, 거래 목록/삭제 확인창에서 KST 기준 날짜를 노출
- `getDisplayDateForMarket`를 도입해 미국 거래는 하루 앞당긴 날짜로 안내(23:30~24:00 체결 케이스 대응)
- 자동 투자 생성 시 기존 동일 일자 거래가 존재하면 건너뛰도록 방어 로직을 추가하고, 정규화 단계에서 중복 자동 투자 거래는 Firestore에서 제거
- `analyzePortfolio`가 포지션을 USD 기준으로 표준화하고 통화별 원/환산 합계를 함께 반환, 분석 화면에서 기준 통화 카드·통화별 카드 제공
- 프런트엔드 `Transaction` 상태 타입을 확장하여 `displayDate` 필드를 안전하게 처리
- 통화 토글(헤더/각 페이지)을 제거하고, KRW 자산은 항상 원화로 표시되도록 `CurrencyContext`/리밸런싱 UI를 정비
- 리밸런싱 시뮬레이터와 자동 리밸런싱 제안 결과가 각 종목의 원화/달러 단위에 맞춰 금액을 표시하도록 환산 로직 보완

## 신규 기능 및 손익 검증 강화 (2025-11-03 오후)
- 매수/매도 시 통화별 잔액 자동 차감·증액, 잔액 부족/임계치 도달 시 이메일 알림 훅(`services/balance`, `notifications`) 추가
- 거래 생성/삭제 플로우에서 잔액을 동기화하고, 삭제 시에는 거래 유형별 현금 흐름을 롤백 처리
- 거래 입력/매도 모달에 `거래 시간` 입력 필드를 추가하고, Firestore에 `executedAt` ISO 타임스탬프 저장 → 거래 목록/삭제 다이얼로그에 시간 표시
- 자동 투자 생성 시 잔액 부족을 감지하여 거래를 건너뛰고 경고 로그를 남기도록 보완
- 리밸런싱 계산 기준을 원화(KRW)로 통일하고, 계산 결과는 각 종목의 원 통화로 다시 표시되도록 `portfolio-analysis`/`RebalancingSimulator` 로직 정리
- 손익 오차 진단을 위한 QA 스크립트 `scripts/qa/profit-discrepancy-report.js` 작성 및 `npm run qa:profit` 스크립트 등록

