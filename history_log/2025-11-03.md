# 2025-11-03 작업 내역

## 통화 로직 개선
- `lib/currency.ts` 신규 추가, USD/KRW 환율 캐시 및 변환 유틸 정리
- `calculatePortfolioTotals`/`calculateTransactionStats` 등 통화 합산 로직 일원화
- `/api/balance`, `/api/transactions` 응답에 환율 메타 및 합산 정보 포함
- `PortfolioOverview`, `TransactionsPage` 표시 로직을 통합 데이터에 맞게 정리

## AI 어드바이저 안정화
- `/api/ai-advisor`에서 `GPT_OSS_API_KEY` 사전 검사 및 표준 에러 코드 응답
- `AIAdvisorResult` 구조화(`recommendations` 객체화, `riskScore` 등 추가)
- `AIAdvisorCard`, 주간 리포트에서 새 데이터 구조와 에러 메시지 대응

## 포트폴리오 분석 화면 리팩터링
- `components/analysis/*` 하위에 `RiskSection`, `AllocationPieChart`, `TopContributorsChart`, `GPTSummaryCard`, `RecommendationList` 분리
- `portfolio/analysis/page.tsx`를 모듈화된 컴포넌트 기반 레이아웃으로 교체 및 AI 진단 연동

## QA 자동화
- `scripts/qa/dashboard-consistency-check.js` 추가, 포지션 총액 vs 거래 총액 검증 스크립트 작성
- `package.json`에 `npm run qa:consistency` 스크립트 등록

## 거래 이력 및 자동 투자 개선
- `/api/transactions`에 미래 일자 검증 추가, 잘못된 거래 등록 차단
- 국내 종목 통화 판별 로직 강화(`lib/services/transaction.ts`, `transactions/page.tsx`)로 4/6자리 숫자 티커는 KRW로 통일 표시
- 거래 API에서 `upcomingAutoInvests` 정보 제공 및 UI 카드 추가로 당일 자동 투자 예정·완료 상태 시각화

## 손익 계산 로직 보강
- 수익률 계산을 총 투자금 기준으로 통일(`calculateReturnRate` 재정의)하고 마지막 체결가 폴백 적용
- `formatPercent` 반올림 로직 조정으로 미세 손익도 표시(-0.01% 등)

## 추가 개선 (거래/손익 정합성)
- `getPortfolioPositions`에 실시간 시세 연동(`AlphaVantage`, `Yahoo Finance`)을 추가하여 평가 금액/수익률을 실제 브로커리지와 동기화
- 거래 정규화 시 주말·미래 일자를 자동 보정하고, 휴일/미래 거래는 Firestore에 수정 반영 (`normalizeTransactions`, `createTransaction`)
- 자동 투자 스케줄에서 다음 실행일 계산을 `getNextScheduledTradingDate` 기반으로 재구성하고 UI에서 `대기/오늘/완료` 상태를 구분 표시
- `auto-invest` 생성 시 미래 거래를 무시하고, 거래 화면에 예정 안내 문구를 세분화

