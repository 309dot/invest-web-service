<!-- 99449d84-aaf8-4d68-a022-53512a4582d4 1b17b863-cc7e-403d-a6b7-4a66d09e06fe -->
# 포트폴리오 분석 완전 개선 및 버그 수정

## 1. 자동 투자 기능 버그 수정

### 문제 분석

- 자동 투자 스케줄은 생성되지만 실제 거래 내역이 생성되지 않음
- `generateAutoInvestTransactions` 함수가 호출되지만 잔액 부족으로 실패하는 것으로 추정
- 대시보드에 반영되지 않고 충전 금액 차감도 확인 불가

### 수정 작업

- `lib/services/auto-invest.ts`: `generateAutoInvestTransactions` 함수에서 잔액 부족 시 더 명확한 에러 로깅 추가
- `app/api/positions/[id]/auto-invest/route.ts`: POST 요청 시 거래 생성 실패 원인을 응답에 포함
- 자동 투자 거래 생성 시 잔액 확인 로직 개선
- 거래 생성 실패 시 사용자에게 명확한 피드백 제공

## 2. 주식 단위 표시 형식 통일 (소수점 6자리)

### 수정 대상 파일

- `lib/utils/formatters.ts`: `formatShares` 함수를 소수점 6자리로 통일
- `lib/services/auto-invest.ts`: 주식 수량 계산 시 소수점 6자리 유지 (이미 적용됨)
- 모든 컴포넌트에서 `toFixed(4)` → `toFixed(6)` 변경:
- `components/SellStockModal.tsx`
- `components/TransactionForm.tsx`
- `app/transactions/page.tsx`
- 기타 주식 수량을 표시하는 모든 위치

## 3. 포트폴리오 분석 화면 Phase 1 개선 (긴급)

### 3.1 섹터 정보 정확성 개선

**현재 문제**: "미분류 51.2%" 표시
**해결 방안**:

- `lib/services/portfolio-analysis.ts`: `calculateSectorAllocation` 함수 개선
- 종목 마스터 데이터에서 실제 섹터 정보 가져오기
- ETF의 경우 내부 섹터 구성 파악 로직 추가
- GICS 11개 섹터 기준으로 분류

### 3.2 벤치마크 비교 기능 추가

**새로운 기능**:

- `lib/services/benchmark.ts` 생성: KOSPI, S&P500 등 벤치마크 데이터 조회
- `components/analysis/BenchmarkComparison.tsx` 생성: 벤치마크 대비 성과 표시
- 포트폴리오 수익률과 주요 지수 비교 차트

### 3.3 기간별 성과 탭 추가

**새로운 기능**:

- `components/analysis/PerformanceTabs.tsx` 생성: 1일/1주/1개월/3개월/YTD/1년/전체 탭
- 각 기간별 수익률 계산 로직 추가
- 연환산 수익률 계산 및 표시

### 3.4 리스크 지표 설명 개선

**개선 사항**:

- `components/analysis/RiskSection.tsx` 개선: 각 지표에 툴팁 추가
- 샤프 비율, MDD 등의 의미와 기준 설명
- 사용자 친화적인 해석 제공

## 4. 포트폴리오 분석 화면 Phase 2 개선 (핵심)

### 4.1 AI 조언 구체화

**개선 사항**:

- `lib/services/ai-advisor.ts` 개선: 프롬프트에 실행 가능한 액션 아이템 요청
- `components/analysis/GPTSummaryCard.tsx` 개선: 우선순위 기반 액션 플랜 표시
- 긴급/중요/권장 레벨로 구분
- 각 액션에 대한 구체적인 방법과 예상 효과 제시

### 4.2 리밸런싱 실행 계획 상세화

**개선 사항**:

- `components/RebalancingSimulator.tsx` 개선:
- 스마트 목표 비중 제안 (균등 분산, AI 추천, 안정형, 공격형)
- 상세 실행 계획 (매도/매수 순서, 금액, 수수료 예상)
- Before/After 비교 시뮬레이션
- 세금 최적화 옵션

### 4.3 종목 비교 차트 구현

**개선 사항**:

- `components/MultiStockChart.tsx` 개선: 인터랙티브 차트로 업그레이드
- 종목별 성과 비교 테이블 추가
- 상대 성과 분석 (Outperformers/Underperformers)

### 4.4 수익 기여도 분해 분석

**개선 사항**:

- `components/analysis/TopContributorsChart.tsx` 개선:
- 비중 기여 vs 성과 기여 분해
- 시계열 추이 표시
- 전체 포트폴리오 트리맵 시각화

### 4.5 상관관계 히트맵

**새로운 기능**:

- `components/analysis/CorrelationHeatmap.tsx` 생성
- 종목 간 상관관계 계산 및 시각화
- 진짜 분산 효과 분석

## 5. 포트폴리오 분석 화면 Phase 3 개선 (경험 향상)

### 5.1 개인화 대시보드

**새로운 기능**:

- 투자 성향 설정 기능 추가
- 성향별 맞춤형 지표 강조
- 상황별 대시보드 (강세장/약세장 모드)

### 5.2 교육 컨텐츠 통합

**새로운 기능**:

- 각 지표에 대한 상세 설명 모달
- 온보딩 가이드 추가
- 용어 사전 기능

## 6. 데이터 구조 및 타입 개선

### 수정 사항

- `types/index.ts`: 새로운 분석 관련 타입 추가
- Firestore 구조 업데이트 (필요시)
- API 응답 형식 표준화

## 7. 테스트 및 QA

### 작업 내역

- 자동 투자 기능 전체 플로우 테스트
- 분석 화면 각 기능별 테스트
- 성능 테스트 (대량 데이터 처리)
- 모바일 반응형 테스트

## 8. 문서화

### 작업 내역

- `history_log/2025-11-10.md` 생성: 오늘 작업 내역 기록
- 각 새로운 기능에 대한 JSDoc 주석 추가
- API 문서 업데이트

## 구현 우선순위

1. **긴급 (즉시)**: 자동 투자 버그 수정, 주식 단위 표시 통일
2. **Phase 1 (1-2주)**: 섹터 정보, 벤치마크 비교, 기간별 성과, 리스크 지표 설명
3. **Phase 2 (3-4주)**: AI 조언 구체화, 리밸런싱 상세화, 종목 비교, 수익 기여도, 상관관계
4. **Phase 3 (5-8주)**: 개인화, 교육 컨텐츠

## 기술적 고려사항

- 벤치마크 데이터 소스: Alpha Vantage 또는 Yahoo Finance API
- 상관관계 계산: 최근 3개월 일별 수익률 기반
- 캐싱 전략: 분석 결과 Redis 캐싱 (향후)
- 성능 최적화: 대량 데이터 처리 시 Web Worker 활용 검토

### To-dos

- [ ] 자동 투자 기능 버그 수정 - 거래 내역 생성 실패 원인 파악 및 해결
- [ ] 주식 단위 표시를 소수점 6자리로 통일 (formatters.ts 및 모든 컴포넌트)
- [ ] 섹터 정보 정확성 개선 - 미분류 제거 및 실제 섹터 데이터 연동
- [ ] 벤치마크 비교 기능 추가 - KOSPI, S&P500 대비 성과 표시
- [ ] 기간별 성과 탭 추가 - 1일/1주/1개월/3개월/YTD/1년/전체
- [ ] 리스크 지표 설명 개선 - 툴팁 및 사용자 친화적 해석 추가
- [ ] AI 조언 구체화 - 우선순위 기반 실행 가능한 액션 플랜
- [ ] 리밸런싱 실행 계획 상세화 - 스마트 제안, 실행 계획, Before/After 비교
- [ ] 종목 비교 차트 개선 - 인터랙티브 차트 및 성과 비교 테이블
- [ ] 수익 기여도 분해 분석 - 비중/성과 기여 분리, 시계열 추이, 트리맵
- [ ] 상관관계 히트맵 추가 - 종목 간 상관관계 계산 및 시각화
- [ ] 개인화 대시보드 - 투자 성향별 맞춤형 지표 및 상황별 모드
- [ ] 교육 컨텐츠 통합 - 지표 설명 모달, 온보딩 가이드, 용어 사전
- [ ] 전체 기능 테스트 및 QA - 자동 투자, 분석 화면, 성능, 반응형
- [ ] 문서화 - history_log 작성, JSDoc 주석, API 문서 업데이트